<!DOCTYPE html>

<!--
Modified from example file by @mbostock (https://github.com/mbostock)
Check this link for original example: http://bl.ocks.org/d3noob/5193723
Licence: 
-->

<meta charset="utf-8">
<style>
path 	{
		  stroke: grey;
		  stroke-width: 0.5px;
		  fill: white;
		}

header 	{
		font-family: "PT Sans", sans-serif;
		font-size: 12px;
		}

footer {
		font-family: "PT Sans", sans-serif;
		font-size: 12px;
		}
	
body 	{
		font-family: "PT Sans", sans-serif;
		font-size: 13px;
		}
</style>

<header>
  <title>epwmap</title>
  Started by <a href="https://github.com/mostaphaRoudsari" rel="author">Mostapha Roudsari</a> at Dec, 21, 2014
  - Inspired by <a href="https://github.com/mbostock" rel="author">Mike Bostock</a> 's
  <a href="http://bl.ocks.org/d3noob/5193723" rel="link">example</a>
</header>

<h1>EnergyPlus Weather Data Map</h1>

<body>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v0.min.js"></script>
<script type="text/javascript" src="http://code.jquery.com/jquery-1.6.2.min.js"></script> 
<script src="./js/jquery.tipsy.js"></script>
<link rel="stylesheet" href="./css/tipsy.css" type="text/css"/>

<div id="wrapper" class="map" style="width:100%;height:500px">

<script>
var width = 1240,
    height = 480;

var projection = d3.geo.mercator()
    .center([-25, 15])
    .scale(300)
    .rotate([-5,0]);

var svg = d3.select('#wrapper')
	.append("svg")
    .attr("width", width)
    .attr("height", height);

var path = d3.geo.path()
    .projection(projection);

var g = svg.append("g");

var circle_radius = 1.2; 
var circle_stroke = .6;
var font_size = "1.5px";

// circle colors based on data source
var circle_colors = {
					"CSWD" : "blue",
					"CWEC" : "orange",
					"CZ01RV2" : "green",
					"CZ02RV2" : "green",
					"CZ03RV2" : "green",
					"CZ04RV2" : "green",
					"CZ05RV2" : "green",
					"CZ06RV2" : "green",
					"CZ07RV2" : "green",
					"CZ08RV2" : "green",
					"CZ09RV2" : "green",
					"CZ10RV2" : "green",
					"CZ11RV2" : "green",
					"CZ12RV2" : "green",
					"CZ13RV2" : "green",
					"CZ14RV2" : "green",
					"CZ15RV2" : "green",
					"CZ16RV2" : "green",
					"CityUHK" : "green",
					"ETMY" : "grey",
					"IGDG" : "grey",
					"IMGW" : "grey",
					"INETI" : "grey",
					"ISHRAE" : "grey",
					"ITMY" : "grey",
					"IWEC" : "brown",
					"KISR" : "grey",
					"MSI" : "grey",
					"NIWA" : "grey",
					"RMY" : "grey",
					"SWEC" : "grey",
					"SWERA" : "red",
					"TMY" : "pink",
					"TMY2" : "yellow",
					"TMY3" : "#e6550d"
					};
					
// load and display the World
d3.json("./json/world-110m2.json", function(error, topology) {
//d3.json("https://dl.dropboxusercontent.com/u/16228160/world-110m2.json", function(error, topology) {

// load and display the cities
d3.csv("./data/epw_weather_data.csv", function(error, data) {
//d3.csv("https://dl.dropboxusercontent.com/u/16228160/epw_weather_data.csv", function(error, data) {
    
	// add countries
	g.selectAll("path")
		  .data(topojson.object(topology, topology.objects.countries)
			  .geometries)
		.enter()
		  .append("path")
		  .attr("d", path)
		  
	// add city names
    g.selectAll("text")
       .data(data)
       .enter()
			.append("text") // append text
			.attr("x", function(d) {
					   return projection([d.lon, d.lat])[0];
				})
			.attr("y", function(d) {
					   return projection([d.lon, d.lat])[1];
				})
			.attr("dy", -(circle_radius + circle_stroke)) // set y position of bottom of text
			.style("fill", "black") // fill the text with the colour black
			.style("font-size", font_size)
			.attr("text-anchor", "middle") // set anchor y justification
			.text(function(d) {return d.station_name;}); // display station name - I should find a better way to do this!

	
	// add circles
	g.selectAll("circle")
       .data(data)
       .enter()
			.append("a")
			.attr("xlink:href", function(d){return d.http_link;})
			.append("g:circle")
			//.append("circle")
			.attr("cx", function(d) {
						return projection([d.lon, d.lat])[0];
				})
			.attr("cy", function(d) {
						return projection([d.lon, d.lat])[1];
				})
	   //.on("click", function(d){ window.open(d.http_link); }) // this is duplication with "xlink"!
       .attr("r", circle_radius)
       .style("stroke", function(d) { return circle_colors[d.data_source];})
	   .style("fill", "white")
	   .style("opacity", .8)
	   .style("stroke-width", circle_stroke);
		
		//tooltip
		$('g circle').tipsy({ 
			gravity: 'w', 
			html: true, 
			title: function(d) {
			  var d = this.__data__;
			  return '<span style="font size:18px"> Station Name: ' + d.station_name + '<br> Data Source: ' + d.data_source + '<br><span>' +
					 '<span> Latitude: ' + d.lat + '<br> Longitude: ' + d.lon + '<br><span>'; 
			}
      });
});

});
	// zoom and pan
	var zoom = d3.behavior.zoom()
		.on("zoom",function() {
			g.attr("transform","translate("+ 
				d3.event.translate.join(",")+")scale("+d3.event.scale+")");
			g.selectAll("circle")
				.attr("d", path.projection(projection));
			g.selectAll("path")  
				.attr("d", path.projection(projection)); 

  });

svg.call(zoom)

</script>
</div>
<div id="description" class="description" style="width:100%;height:80px">
<br><br>
<b>
Zoom and pan to see available weather data stations. Hover on the circle to see more information and click to download the files.
Weather files are hosted by <a href="http://apps1.eere.energy.gov/buildings/energyplus/weatherdata_about.cfm" rel="link">US Department of Energy</a>.
</b>
<br><br>
Weather data information is parsed by <a href="https://github.com/mostaphaRoudsari/ladybug" rel="link">Ladybug</a> || 
Source code: <a href="https://github.com/mostaphaRoudsari/epwmap" rel="link">Github</a> ||  
This page is using <a href="https://github.com/mbostock/D3" rel="link">D3</a> library. Click <a href="http://d3js.org/" rel="link">here</a> for more D3 examples.
<br>
This is a work in Progress... Check <a href="https://github.com/mostaphaRoudsari/epwmap/issues?q=is%3Aopen+is%3Aissue" rel="link">open issues</a> on Github to help or add new issues or get in touch >
 <a style="margin-left:10px;" href ="https://www.linkedin.com/in/mostaphasadeghipour" target="blank"> Linkedin </a>
 <a style="margin-left:10px;" href ="https://twitter.com/__Mostapha__" target="blank"> Twitter </a>
 <a style="margin-left:10px;" href ="https://github.com/mostapharoudsari" target="blank"> Github </a>
</div>

<script>
  // google analytic
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-57902264-1', 'auto');
  ga('send', 'pageview');

</script>

</body>
</html>
